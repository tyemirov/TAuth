<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>TAuth Demo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
            integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+"
            crossorigin="anonymous"
        />
        <script src="/demo/config.js"></script>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="/static/auth-client.js"></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@0.0.5/mpr-ui.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
        ></script>
        <style>
            :root {
                --demo-gradient-light: radial-gradient(
                    120% 120% at 50% 0%,
                    #f5fbff 0%,
                    #e6f0ff 48%,
                    #dce7ff 100%
                );
                --demo-gradient-dark: radial-gradient(
                    120% 120% at 50% 10%,
                    #132336 0%,
                    #0f172a 60%,
                    #030712 100%
                );
                --demo-card-shadow-light: 0 24px 48px rgba(12, 52, 111, 0.16);
                --demo-card-shadow-dark: 0 32px 54px rgba(3, 11, 29, 0.72);
                --demo-muted-light: #53627b;
                --demo-muted-dark: #c4d0e6;
                --demo-code-border-light: rgba(126, 143, 170, 0.28);
                --demo-code-border-dark: rgba(94, 139, 211, 0.3);
            }

            body {
                background: var(--demo-gradient-light);
                transition: background 220ms ease;
            }

            body[data-bs-theme="dark"] {
                background: var(--demo-gradient-dark);
            }

            .demo-card {
                border-radius: 1.25rem;
                background: rgba(255, 255, 255, 0.94);
                border: 1px solid rgba(18, 68, 128, 0.1);
                box-shadow: var(--demo-card-shadow-light);
            }

            body[data-bs-theme="dark"] .demo-card {
                background: rgba(17, 27, 48, 0.9);
                border-color: rgba(90, 130, 210, 0.22);
                box-shadow: var(--demo-card-shadow-dark);
            }

            .demo-muted {
                color: var(--demo-muted-light);
            }

            body[data-bs-theme="dark"] .demo-muted {
                color: var(--demo-muted-dark);
            }

            .demo-output {
                border-radius: 1rem;
                background: rgba(5, 13, 30, 0.94);
                border: 1px solid var(--demo-code-border-light);
                padding: 1.25rem;
                color: #e7eefc;
                max-height: 22rem;
                overflow: auto;
                font-size: 0.9rem;
                font-family:
                    "JetBrains Mono",
                    "Fira Code",
                    "SFMono-Regular",
                    Menlo,
                    Consolas,
                    monospace;
            }

            body[data-bs-theme="dark"] .demo-output {
                border-color: var(--demo-code-border-dark);
            }

            #landing-footer {
                backdrop-filter: blur(16px);
                box-shadow: 0 -24px 64px rgba(9, 22, 48, 0.18);
            }

            body[data-bs-theme="dark"] #landing-footer {
                box-shadow: 0 -28px 64px rgba(2, 8, 23, 0.8);
            }

            .dropdown-menu {
                min-width: 220px;
            }
        </style>
    </head>
    <body class="landing-body bg-body text-body" data-bs-theme="light">
        <div class="d-flex flex-column min-vh-100">
            <header id="siteHeader" class="container-lg py-3"></header>
            <main class="flex-grow-1 py-5">
            <div class="container-lg">
                <section class="text-center mb-5">
                    <span class="badge bg-primary-subtle text-primary-emphasis mb-3 px-3 py-2">
                        Google Identity + JWT cookies
                    </span>
                    <h1 class="display-5 fw-semibold mb-3">Sign in with Google via TAuth</h1>
                    <p class="lead demo-muted mx-auto" style="max-width: 640px">
                        Request nonce-protected Google credentials, swap them for first-party cookies,
                        and inspect the session contract this service documents in the README.
                    </p>
                </section>
                <div id="demoNotice" class="alert alert-danger d-none" role="status"></div>
                <div class="row g-4 align-items-start">
                    <section class="col-12 col-lg-6" data-panel="signed-out">
                        <div class="demo-card border-0 p-4 h-100">
                            <div class="d-flex flex-column gap-3">
                                <div>
                                    <h2 class="h4 fw-semibold mb-2">Ready to sign in</h2>
                                    <p class="mb-0 demo-muted">
                                        Use the header’s <strong>Sign in</strong> button to launch Google Identity Services.
                                    </p>
                                </div>
                                <p class="mb-0 demo-muted">
                                    TAuth issues a one-time nonce for every attempt so replayed credentials are rejected automatically.
                                </p>
                            </div>
                        </div>
                    </section>
                    <section class="col-12 col-lg-6 d-none" data-panel="signed-in">
                        <div class="demo-card border-0 p-4 h-100">
                            <div class="d-flex flex-column gap-3">
                                <div>
                                    <h2 class="h4 fw-semibold mb-2">You’re signed in</h2>
                                    <p class="mb-0 demo-muted">
                                        The profile below reflects session cookies set by the backend. Call the
                                        protected API to inspect the authenticated contract.
                                    </p>
                                </div>
                                <div id="profileSummary"></div>
                                <div class="d-flex flex-wrap gap-2">
                                    <button id="callApiButton" class="btn btn-primary px-4">
                                        Call /api/me
                                    </button>
                                    <button id="logoutButton" class="btn btn-outline-primary px-4">
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="col-12">
                        <div class="demo-card border-0 p-4">
                            <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
                                <div>
                                    <h2 class="h5 fw-semibold mb-1">Activity log</h2>
                                    <p class="mb-0 demo-muted">
                                        Outputs nonce issuance, credential exchange, and protected API calls.
                                    </p>
                                </div>
                                <i class="bi bi-journal-code fs-4 text-primary-emphasis"></i>
                            </div>
                            <pre id="demoOutput" class="demo-output">{"state":"idle"}</pre>
                        </div>
                    </section>
                </div>
            </div>
            </main>
            <footer id="landing-footer" class="mt-auto"></footer>
        </div>
        <script>
            (function () {
                function applyTheme(mode) {
                    var normalized = mode === "dark" ? "dark" : "light";
                    document.body.setAttribute("data-bs-theme", normalized);
                }

                var initialMode =
                    document.documentElement.getAttribute("data-mpr-theme-mode") ||
                    document.documentElement.getAttribute("data-mpr-theme") ||
                    document.body.getAttribute("data-bs-theme") ||
                    "light";
                applyTheme(initialMode);

                document.addEventListener("mpr-ui:theme-change", function (eventObject) {
                    var detail = eventObject && eventObject.detail ? eventObject.detail : {};
                    applyTheme(detail.theme);
                });
            })();
        </script>
        <script>
            (function () {
                const config = window.__TAUTH_DEMO_CONFIG || {};
                const configuredBase = typeof config.baseUrl === "string" ? config.baseUrl.trim() : "";
                const tauthBaseUrl = configuredBase ? configuredBase.replace(/\/+$/, "") : window.location.origin;
                const googleClientId = typeof config.googleClientId === "string" ? config.googleClientId : "";

                const headerHost = document.getElementById("siteHeader");
                const footerHost = document.getElementById("landing-footer");
                const noticeElement = document.getElementById("demoNotice");
                const signedOutPanel = document.querySelector('[data-panel="signed-out"]');
                const signedInPanel = document.querySelector('[data-panel="signed-in"]');
                const activityOutput = document.getElementById("demoOutput");

                const footerLinks = [
                    { label: "Marco Polo Research Lab", href: "https://mprlab.com" },
                    { label: "Gravity Notes", href: "https://gravity.mprlab.com" },
                    { label: "LoopAware", href: "https://loopaware.mprlab.com" },
                    { label: "Allergy Wheel", href: "https://allergy.mprlab.com" },
                    { label: "Social Threader", href: "https://threader.mprlab.com" },
                    { label: "RSVP", href: "https://rsvp.mprlab.com" },
                    { label: "Countdown Calendar", href: "https://countdown.mprlab.com" },
                    { label: "LLM Crossword", href: "https://llm-crossword.mprlab.com" },
                    { label: "Prompt Bubbles", href: "https://prompts.mprlab.com" },
                    { label: "Wallpapers", href: "https://wallpapers.mprlab.com" },
                ];

                if (headerHost) {
                    MPRUI.renderSiteHeader(headerHost, {
                        brand: {
                            label: "TAuth Demo",
                            href: "/demo",
                        },
                        navLinks: [
                            { label: "README", href: "https://github.com/tyemirov/TAuth#readme" },
                            { label: "Architecture", href: "https://github.com/tyemirov/TAuth/blob/master/ARCHITECTURE.md" },
                        ],
                        auth: {
                            baseUrl: tauthBaseUrl,
                            loginPath: "/auth/google",
                            logoutPath: "/auth/logout",
                            noncePath: "/auth/nonce",
                            googleClientId: googleClientId,
                        },
                    });
                }

                if (footerHost) {
                    MPRUI.renderFooter(footerHost, {
                        baseClass: "landing-footer border-top py-3",
                        innerClass: "container d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3",
                        brandWrapperClass: "d-inline-flex align-items-center gap-2 text-body-secondary small",
                        menuWrapperClass: "dropup",
                        prefixClass: "text-body-secondary fw-semibold",
                        prefixText: "Built by",
                        toggleButtonClass: "btn btn-link dropdown-toggle text-decoration-none px-0 fw-semibold text-body-secondary",
                        toggleLabel: "Marco Polo Research Lab",
                        menuClass: "dropdown-menu dropdown-menu-end shadow",
                        menuItemClass: "dropdown-item",
                        privacyLinkClass: "text-body-secondary text-decoration-none small",
                        privacyLinkHref: "https://mprlab.com/privacy",
                        privacyLinkLabel: "Privacy • Terms",
                        themeToggle: {
                            enabled: true,
                            wrapperClass: "form-check form-switch m-0",
                            inputClass: "form-check-input",
                            inputId: "public-theme-toggle",
                            ariaLabel: "Toggle theme",
                        },
                        links: footerLinks,
                    });
                }

                function withBase(path) {
                    if (!path) {
                        return tauthBaseUrl;
                    }
                    if (/^https?:\/\//i.test(path)) {
                        return path;
                    }
                    if (path.startsWith("/")) {
                        return `${tauthBaseUrl}${path}`;
                    }
                    return `${tauthBaseUrl}/${path}`;
                }

                function setOutput(payload) {
                    if (activityOutput) {
                        activityOutput.textContent = JSON.stringify(payload, null, 2);
                    }
                }

                function clearNotice() {
                    if (!noticeElement) {
                        return;
                    }
                    noticeElement.classList.add("d-none");
                    noticeElement.textContent = "";
                }

                function showNotice(message) {
                    if (!noticeElement) {
                        return;
                    }
                    noticeElement.textContent = message;
                    noticeElement.classList.remove("d-none");
                }

                function renderProfileSummary(profile) {
                    const target = document.getElementById("profileSummary");
                    if (!target) {
                        return;
                    }
                    if (!profile) {
                        target.innerHTML = "";
                        return;
                    }
                    const displayName =
                        profile.display ||
                        profile.display_name ||
                        profile.user_email ||
                        profile.user_id ||
                        "Authenticated user";
                    const userEmail = profile.user_email || "Email unavailable";
                    const userId = profile.user_id || profile.id || "unknown";
                    const initials =
                        displayName
                            .split(" ")
                            .map((word) => word.charAt(0))
                            .join("")
                            .slice(0, 2)
                            .toUpperCase() || "?";
                    const avatarMarkup = profile.avatar_url
                        ? `<img src="${profile.avatar_url}" alt="User avatar" class="rounded-circle img-fluid" />`
                        : `<span class="fs-4 fw-semibold">${initials}</span>`;
                    target.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <span class="rounded-circle bg-primary-subtle text-primary-emphasis d-inline-flex justify-content-center align-items-center" style="width:64px;height:64px;">
                            ${avatarMarkup}
                        </span>
                        <div class="d-flex flex-column small text-start">
                            <strong class="fs-6">${displayName}</strong>
                            <span>${userEmail}</span>
                            <span class="text-body-secondary">ID: ${userId}</span>
                        </div>
                    </div>
                `;
                }

                function showSignedOut() {
                    if (signedOutPanel) {
                        signedOutPanel.classList.remove("d-none");
                    }
                    if (signedInPanel) {
                        signedInPanel.classList.add("d-none");
                    }
                    renderProfileSummary(null);
                }

                function showSignedIn(profile) {
                    if (signedOutPanel) {
                        signedOutPanel.classList.add("d-none");
                    }
                    if (signedInPanel) {
                        signedInPanel.classList.remove("d-none");
                    }
                    renderProfileSummary(profile);
                }

                async function refreshSession(eventLabel) {
                    try {
                        await window.initAuthClient({
                            baseUrl: tauthBaseUrl,
                            onAuthenticated(profile) {
                                clearNotice();
                                showSignedIn(profile);
                                if (eventLabel) {
                                    setOutput({ event: eventLabel, profile });
                                } else {
                                    setOutput({ state: "signed_in", profile });
                                }
                            },
                            onUnauthenticated() {
                                showSignedOut();
                                setOutput({ state: "signed_out" });
                            },
                        });
                    } catch (error) {
                        showSignedOut();
                        showNotice("Unable to hydrate the session. Please sign in again.");
                        setOutput({ error: "auth_client_init_failed", detail: String(error) });
                    }
                }

                function bindUiHandlers() {
                    const callApiButton = document.getElementById("callApiButton");
                    const logoutButton = document.getElementById("logoutButton");
                    if (callApiButton) {
                        callApiButton.addEventListener("click", async () => {
                            try {
                                const response = await window.apiFetch(withBase("/api/me"), { method: "GET" });
                                const body = await response.json();
                                setOutput({ event: "/api/me", status: response.status, body });
                                if (response.status === 401) {
                                    showSignedOut();
                                }
                            } catch (error) {
                                showNotice("Unable to reach /api/me. Check the console for details.");
                                setOutput({ error: "api_me_failed", detail: String(error) });
                            }
                        });
                    }
                    if (logoutButton) {
                        logoutButton.addEventListener("click", async () => {
                            clearNotice();
                            await window.logout();
                            showSignedOut();
                            setOutput({ event: "signed_out" });
                        });
                    }
                }

                if (headerHost) {
                    headerHost.addEventListener("mpr-ui:auth:authenticated", () => {
                        refreshSession("signed_in");
                    });
                    headerHost.addEventListener("mpr-ui:auth:unauthenticated", () => {
                        showSignedOut();
                        setOutput({ event: "signed_out" });
                    });
                    headerHost.addEventListener("mpr-ui:auth:error", (eventObject) => {
                        const detail = eventObject && eventObject.detail ? eventObject.detail : {};
                        showNotice("Authentication error. Please try again.");
                        setOutput({ error: detail.code || "mpr-ui.auth.error", detail });
                    });
                    headerHost.addEventListener("mpr-ui:header:error", (eventObject) => {
                        const detail = eventObject && eventObject.detail ? eventObject.detail : {};
                        showNotice("Google prompt failed. Please retry.");
                        setOutput({ error: detail.code || "mpr-ui.header.error", detail });
                    });
                }

                bindUiHandlers();
                refreshSession("hydrated");
            })();
        </script>
    </body>
</html>
